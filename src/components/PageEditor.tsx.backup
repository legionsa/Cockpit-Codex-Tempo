import React, { useEffect, useRef, useState } from 'react';
import EditorJS, { OutputData } from '@editorjs/editorjs';
import Header from '@editorjs/header';
import List from '@editorjs/list';
import Paragraph from '@editorjs/paragraph';
import Checklist from '@editorjs/checklist';
import Quote from '@editorjs/quote';
import Warning from '@editorjs/warning';
import Delimiter from '@editorjs/delimiter';
import Table from '@editorjs/table';
import Code from '@editorjs/code';
import Embed from '@editorjs/embed';
import Image from '@editorjs/image';
// @ts-ignore
import RawTool from '@editorjs/raw';
import IconTool from './editor-tools/IconTool';
import ComponentPropsBlock from './editor-tools/ComponentPropsBlock';
import CodeExampleBlock from './editor-tools/CodeExampleBlock';
import GalleryBlock from './editor-tools/GalleryBlock';
import { IconLibraryModal } from './IconLibraryModal';
import { EditorJSContent } from '@/types/page';

interface PageEditorProps {
  content: EditorJSContent;
  onChange: (content: EditorJSContent) => void;
  readOnly?: boolean;
}

export function PageEditor({ content, onChange, readOnly = false }: PageEditorProps) {
  const editorRef = useRef<EditorJS | null>(null);
  const holderRef = useRef<HTMLDivElement>(null);
  const [isReady, setIsReady] = useState(false);
  const initialContentRef = useRef(content);
  const [showIconLibrary, setShowIconLibrary] = useState(false);
  const [iconCallback, setIconCallback] = useState<((icon: any) => void) | null>(null);

  useEffect(() => {
    const handleOpenIconLibrary = (e: any) => {
      setIconCallback(() => e.detail.callback);
      setShowIconLibrary(true);
    };

    window.addEventListener('openIconLibrary', handleOpenIconLibrary);
    return () => window.removeEventListener('openIconLibrary', handleOpenIconLibrary);
  }, []);

  useEffect(() => {
    let isMounted = true;
    let editorInstance: EditorJS | null = null;

    const initEditor = async () => {
      // Cleanup existing editor
      if (editorRef.current) {
        try {
          await editorRef.current.destroy();
          editorRef.current = null;
        } catch (error) {
          console.error('Error destroying editor:', error);
        }
        setIsReady(false);
      }
    };
  }, [readOnly]); // Only recreate when readOnly changes

  return (
    <div className="bg-background">
      <div
        ref={holderRef}
        id="editorjs"
        className="prose prose-slate dark:prose-invert max-w-none min-h-[400px] p-4 border border-border rounded-lg"
      />
      <IconLibraryModal
        open={showIconLibrary}
        onClose={() => setShowIconLibrary(false)}
        onSelectIcon={(icon) => {
          if (iconCallback) {
            iconCallback(icon);
          }
          setShowIconLibrary(false);
        }}
      />
    </div>
  );
}